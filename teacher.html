<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель учителя - Уроки Python</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .filters-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .filter-group input {
            background-color: white;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .sort-btn:hover {
            background: #2980b9;
        }

        .sort-btn.active {
            background: #2980b9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .apply-btn {
            padding: 12px 30px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .apply-btn:hover {
            background: #27ae60;
        }

        .reset-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        .results-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .results-header h2 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .total-count {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .students-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #2980b9;
        }

        th.sort-asc::after {
            content: " ↑";
            font-weight: bold;
        }

        th.sort-desc::after {
            content: " ↓";
            font-weight: bold;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .class-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .experience-cell {
            font-weight: 600;
            color: #27ae60;
        }

        .level-cell {
            display: inline-block;
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .level-cell.level-1 { background: #e74c3c; }
        .level-cell.level-2 { background: #e67e22; }
        .level-cell.level-3 { background: #f39c12; }
        .level-cell.level-4 { background: #f1c40f; }
        .level-cell.level-5 { background: #2ecc71; }
        .level-cell.level-6 { background: #1abc9c; }
        .level-cell.level-7 { background: #3498db; }
        .level-cell.level-8 { background: #9b59b6; }
        .level-cell.level-9 { background: #34495e; }
        .level-cell.level-10 { background: #2c3e50; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .filters-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .actions-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .sort-buttons {
                justify-content: center;
            }
            
            .apply-btn, .reset-btn {
                width: 100%;
            }
            
            .stats-summary {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Панель учителя - Уроки Python</h1>
            <button class="logout-btn" id="logoutBtn">Выйти</button>
        </div>
    </div>

    <div class="container">
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="gradeFilter">Класс:</label>
                    <select id="gradeFilter">
                        <option value="">Все классы</option>
                        <option value="8">8 класс</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="classLetterFilter">Буква класса:</label>
                    <select id="classLetterFilter">
                        <option value="">Все буквы</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>

                    </select>
                </div>

                <div class="filter-group">
                    <label for="subgroupFilter">Подгруппа:</label>
                    <select id="subgroupFilter">
                        <option value="">Все подгруппы</option>
                        <option value="1">Подгруппа 1</option>
                        <option value="2">Подгруппа 2</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchFilter">Поиск по фамилии:</label>
                    <input type="text" id="searchFilter" placeholder="Введите фамилию">
                </div>
            </div>

            <div class="actions-row">
                <div class="sort-buttons">
                    <button class="sort-btn" id="sortByName">Сортировать по фамилии</button>
                    <button class="sort-btn" id="sortByExperience">Сортировать по опыту</button>
                    <button class="sort-btn" id="sortByClass">Сортировать по классу</button>
                    <button class="sort-btn" id="sortByLevel">Сортировать по уровню</button>
                </div>
                <div>
                    <button class="reset-btn" id="resetFilters">Сбросить фильтры</button>
                    <button class="apply-btn" id="applyFilters">Применить фильтры</button>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <h2>Результаты учеников</h2>
                <div class="total-count" id="totalCount">Загрузка данных...</div>
            </div>

            <div class="students-table">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th data-sort="lastName">Фамилия</th>
                            <th data-sort="firstName">Имя</th>
                            <th data-sort="grade">Класс</th>
                            <th data-sort="classLetter">Буква</th>
                            <th data-sort="subgroup">Подгруппа</th>
                            <th data-sort="lastLogin">Последний вход</th>
                            <th data-sort="currentPart">Урок</th>
                            <th data-sort="currentLevel">Уровень</th>
                            <th data-sort="experience">Опыт</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- Данные будут загружаться сюда -->
                    </tbody>
                </table>
                <div id="noDataMessage" class="no-data">
                    Нет данных для отображения. Выберите другие фильтры или добавьте учеников.
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-item">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Всего учеников</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgLevel">0</div>
                    <div class="stat-label">Средний уровень</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgExperience">0</div>
                    <div class="stat-label">Средний опыт</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeToday">0</div>
                    <div class="stat-label">Активных сегодня</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL вашего Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbwZkEot5UHuM8xFbEE3n9qcF6wyOXSuQqVgVeuc4dx7WYbAoiXmunZY0UQTmzlKlBWU/exec';
        const SCRIPT_PASSWORD = 'teacher123';

        // Проверка авторизации учителя
        function checkTeacherAuth() {
            if (sessionStorage.getItem('teacherLoggedIn') !== 'true') {
                window.location.href = 'index.html';
            }
        }

        // Данные учеников
        let allStudents = [];
        let filteredStudents = [];
        let currentSort = 'lastName';
        let sortAscending = true;

        // Функция для загрузки данных с Google Sheets
        async function loadStudentsFromServer() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'getAll',
                        password: SCRIPT_PASSWORD
                    })
                });

                const result = await response.json();
                console.log('Данные с сервера:', result);

                if (result.success && result.students) {
                    return result.students;
                } else {
                    console.error('Ошибка загрузки данных:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Ошибка подключения к серверу:', error);
                return [];
            }
        }

        // Инициализация данных
        async function initData() {
            // Загружаем данные с сервера
            const serverStudents = await loadStudentsFromServer();

            if (serverStudents.length > 0) {
                allStudents = serverStudents;
                console.log('Данные загружены с сервера:', allStudents.length, 'учеников');
            } else {
                // Если нет данных с сервера, используем демо-данные
                allStudents = [
                    {
                        firstName: 'Иван',
                        lastName: 'Иванов',
                        grade: '8',
                        classLetter: 'A',
                        subgroup: '1',
                        lastLogin: new Date().toISOString(),
                        currentPart: 1,
                        currentLevel: 5,
                        experience: 1250
                    }
                ];
            }

            filteredStudents = [...allStudents];
        }

        // Отображение таблицы
        function renderTable() {
            const tbody = document.getElementById('studentsTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const totalCount = document.getElementById('totalCount');
            const totalStudents = document.getElementById('totalStudents');
            const avgLevel = document.getElementById('avgLevel');
            const avgExperience = document.getElementById('avgExperience');
            const activeToday = document.getElementById('activeToday');

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.style.display = 'block';
                totalCount.textContent = 'Всего: 0 учеников';
                totalStudents.textContent = '0';
                avgLevel.textContent = '0';
                avgExperience.textContent = '0';
                activeToday.textContent = '0';
                return;
            }

            noDataMessage.style.display = 'none';
            totalCount.textContent = `Всего: ${filteredStudents.length} учеников`;
            totalStudents.textContent = filteredStudents.length;

            // Рассчитываем статистику
            const totalLevel = filteredStudents.reduce((sum, student) => sum + (student.currentLevel || 0), 0);
            const totalExp = filteredStudents.reduce((sum, student) => sum + (student.experience || 0), 0);
            const today = new Date().toDateString();
            const todayActive = filteredStudents.filter(student => {
                if (!student.lastLogin) return false;
                const loginDate = new Date(student.lastLogin).toDateString();
                return loginDate === today;
            }).length;

            avgLevel.textContent = filteredStudents.length > 0 ? (totalLevel / filteredStudents.length).toFixed(1) : '0';
            avgExperience.textContent = filteredStudents.length > 0 ? Math.round(totalExp / filteredStudents.length) : '0';
            activeToday.textContent = todayActive;

            // Обновляем заголовки сортировки
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort) {
                    th.classList.add(sortAscending ? 'sort-asc' : 'sort-desc');
                }
            });

            let html = '';
            filteredStudents.forEach(student => {
                let formattedDate = 'Нет данных';
                let isToday = false;

                if (student.lastLogin) {
                    const loginDate = new Date(student.lastLogin);
                    formattedDate = loginDate.toLocaleDateString('ru-RU') + ' ' +
                                   loginDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    isToday = new Date().toDateString() === loginDate.toDateString();
                }

                const levelDisplay = student.currentLevel + 1 || 0;

                html += `
                    <tr>
                        <td>${student.lastName || ''}</td>
                        <td>${student.firstName || ''}</td>
                        <td class="class-cell">${student.grade || ''}</td>
                        <td class="class-cell">${student.classLetter || 'А'}</td>
                        <td>${student.subgroup || '1'}</td>
                        <td>${formattedDate} </td>
                        <td><span class="level-cell level-${student.currentPart || 1}">Урок ${student.currentPart || 1}</span></td>
                        <td><span class="level-cell level-${student.currentLevel || 1}">${levelDisplay}</span></td>
                        <td class="experience-cell">${student.experience || 0}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Применение фильтров
        function applyFilters() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const classLetterFilter = document.getElementById('classLetterFilter').value;
            const subgroupFilter = document.getElementById('subgroupFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = allStudents.filter(student => {
                // Фильтр по классу
                if (gradeFilter && student.grade !== gradeFilter) return false;

                // Фильтр по букве класса
                if (classLetterFilter && student.classLetter !== classLetterFilter) return false;

                // Фильтр по подгруппе
                if (subgroupFilter && student.subgroup !== subgroupFilter) return false;

                // Фильтр по фамилии
                if (searchFilter && !student.lastName.toLowerCase().includes(searchFilter)) return false;

                return true;
            });

            // Применяем текущую сортировку
            sortStudents(currentSort, sortAscending);
        }

        // Сортировка студентов
        function sortStudents(sortBy, ascending = true) {
            currentSort = sortBy;
            sortAscending = ascending;

            filteredStudents.sort((a, b) => {
                let valueA, valueB;

                if (sortBy === 'lastName') {
                    valueA = (a.lastName || '').toLowerCase();
                    valueB = (b.lastName || '').toLowerCase();
                } else if (sortBy === 'firstName') {
                    valueA = (a.firstName || '').toLowerCase();
                    valueB = (b.firstName || '').toLowerCase();
                } else if (sortBy === 'grade') {
                    valueA = parseInt(a.grade) || 0;
                    valueB = parseInt(b.grade) || 0;
                } else if (sortBy === 'classLetter') {
                    valueA = a.classLetter || 'А';
                    valueB = b.classLetter || 'А';
                } else if (sortBy === 'subgroup') {
                    valueA = a.subgroup || '';
                    valueB = b.subgroup || '';
                } else if (sortBy === 'lastLogin') {
                    valueA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                    valueB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                } else if (sortBy === 'currentPart') {
                    valueA = a.currentPart || 1;
                    valueB = b.currentPart || 1;
                } else if (sortBy === 'currentLevel') {
                    valueA = a.currentLevel || 1;
                    valueB = b.currentLevel || 1;
                } else if (sortBy === 'experience') {
                    valueA = a.experience || 0;
                    valueB = b.experience || 0;
                }

                if (valueA < valueB) return ascending ? -1 : 1;
                if (valueA > valueB) return ascending ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        // Сброс фильтров
        function resetFilters() {
            document.getElementById('gradeFilter').value = '';
            document.getElementById('classLetterFilter').value = '';
            document.getElementById('subgroupFilter').value = '';
            document.getElementById('searchFilter').value = '';

            filteredStudents = [...allStudents];
            sortStudents('lastName', true);
        }

        // Выход из системы
        function logout() {
            sessionStorage.removeItem('teacherLoggedIn');
            window.location.href = 'index.html';
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            checkTeacherAuth();
            await initData();
            sortStudents('lastName', true);

            // Обработчики событий
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);

            document.getElementById('sortByName').addEventListener('click', function() {
                sortStudents('lastName', true);
            });

            document.getElementById('sortByExperience').addEventListener('click', function() {
                sortStudents('experience', false);
            });

            document.getElementById('sortByClass').addEventListener('click', function() {
                sortStudents('grade', true);
            });

            document.getElementById('sortByLevel').addEventListener('click', function() {
                sortStudents('currentLevel', false);
            });

            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Сортировка по клику на заголовки таблицы
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const sortBy = this.dataset.sort;
                    if (currentSort === sortBy) {
                        sortStudents(sortBy, !sortAscending);
                    } else {
                        sortStudents(sortBy, true);
                    }
                });
            });

            // Применение фильтров при нажатии Enter в поле поиска
            document.getElementById('searchFilter').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // Автоматическое применение фильтров при изменении выпадающих списков
            document.getElementById('gradeFilter').addEventListener('change', applyFilters);
            document.getElementById('classLetterFilter').addEventListener('change', applyFilters);
            document.getElementById('subgroupFilter').addEventListener('change', applyFilters);

            // Обновление данных каждые 30 секунд
            setInterval(async () => {
                const freshStudents = await loadStudentsFromServer();
                if (freshStudents.length > 0) {
                    allStudents = freshStudents;
                    applyFilters();
                }
            }, 30000);
        });
    </script>
</body>
</html>
