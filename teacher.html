<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è - –£—Ä–æ–∫–∏ Python</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .filters-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .filter-group input {
            background-color: white;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .sort-btn:hover {
            background: #2980b9;
        }

        .sort-btn.active {
            background: #2980b9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .apply-btn {
            padding: 12px 30px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .apply-btn:hover {
            background: #27ae60;
        }

        .reset-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        .results-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .results-header h2 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .total-count {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .students-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #2980b9;
        }

        th.sort-asc::after {
            content: " ‚Üë";
            font-weight: bold;
        }

        th.sort-desc::after {
            content: " ‚Üì";
            font-weight: bold;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .class-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .experience-cell {
            font-weight: 600;
            color: #27ae60;
        }

        .level-cell {
            display: inline-block;
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .level-cell.level-1 { background: #e74c3c; }
        .level-cell.level-2 { background: #e67e22; }
        .level-cell.level-3 { background: #f39c12; }
        .level-cell.level-4 { background: #f1c40f; }
        .level-cell.level-5 { background: #2ecc71; }
        .level-cell.level-6 { background: #1abc9c; }
        .level-cell.level-7 { background: #3498db; }
        .level-cell.level-8 { background: #9b59b6; }
        .level-cell.level-9 { background: #34495e; }
        .level-cell.level-10 { background: #2c3e50; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .filters-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .actions-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .sort-buttons {
                justify-content: center;
            }
            
            .apply-btn, .reset-btn {
                width: 100%;
            }
            
            .stats-summary {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è - –£—Ä–æ–∫–∏ Python</h1>
            <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="container">
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="gradeFilter">–ö–ª–∞—Å—Å:</label>
                    <select id="gradeFilter">
                        <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
                        <option value="8">8 –∫–ª–∞—Å—Å</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="classLetterFilter">–ë—É–∫–≤–∞ –∫–ª–∞—Å—Å–∞:</label>
                    <select id="classLetterFilter">
                        <option value="">–í—Å–µ –±—É–∫–≤—ã</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>

                    </select>
                </div>

                <div class="filter-group">
                    <label for="subgroupFilter">–ü–æ–¥–≥—Ä—É–ø–ø–∞:</label>
                    <select id="subgroupFilter">
                        <option value="">–í—Å–µ –ø–æ–¥–≥—Ä—É–ø–ø—ã</option>
                        <option value="1">–ü–æ–¥–≥—Ä—É–ø–ø–∞ 1</option>
                        <option value="2">–ü–æ–¥–≥—Ä—É–ø–ø–∞ 2</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchFilter">–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏:</label>
                    <input type="text" id="searchFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                </div>
            </div>

            <div class="actions-row">
                <div class="sort-buttons">
                    <button class="sort-btn" id="sortByName">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ñ–∞–º–∏–ª–∏–∏</button>
                    <button class="sort-btn" id="sortByExperience">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ–ø—ã—Ç—É</button>
                    <button class="sort-btn" id="sortByClass">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∫–ª–∞—Å—Å—É</button>
                    <button class="sort-btn" id="sortByLevel">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É—Ä–æ–≤–Ω—é</button>
                </div>
                <div>
                    <button class="reset-btn" id="resetFilters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button class="apply-btn" id="applyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤</h2>
                <div class="total-count" id="totalCount">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>

            <div class="students-table">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th data-sort="lastName">–§–∞–º–∏–ª–∏—è</th>
                            <th data-sort="firstName">–ò–º—è</th>
                            <th data-sort="grade">–ö–ª–∞—Å—Å</th>
                            <th data-sort="classLetter">–ë—É–∫–≤–∞</th>
                            <th data-sort="subgroup">–ü–æ–¥–≥—Ä—É–ø–ø–∞</th>
                            <th data-sort="lastLogin">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                            <th data-sort="currentPart">–£—Ä–æ–∫</th>
                            <th data-sort="currentLevel">–£—Ä–æ–≤–µ–Ω—å</th>
                            <th data-sort="experience">–û–ø—ã—Ç</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
                    </tbody>
                </table>
                <div id="noDataMessage" class="no-data">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤.
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-item">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgLevel">0</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgExperience">0</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –æ–ø—ã—Ç</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeToday">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL –≤–∞—à–µ–≥–æ Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycby7-PMwDOy11PysIDD0DSLkAcB7nq_fugQx6o92RPSYRRd-35Cp9XeC6noO-artX7XT/exec';
        const SCRIPT_PASSWORD = 'teacher123';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É—á–∏—Ç–µ–ª—è
        function checkTeacherAuth() {
            if (sessionStorage.getItem('teacherLoggedIn') !== 'true') {
                window.location.href = 'index.html';
            }
        }

        // –î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–æ–≤
        let allStudents = [];
        let filteredStudents = [];
        let currentSort = 'lastName';
        let sortAscending = true;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å Google Sheets
        async function loadStudentsFromServer() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        action: 'getAll',
                        password: SCRIPT_PASSWORD
                    })
                });

                const result = await response.json();
                console.log('–î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:', result);

                if (result.success && result.students) {
                    return result.students;
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É:', error);
                return [];
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function initData() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const serverStudents = await loadStudentsFromServer();

            if (serverStudents.length > 0) {
                allStudents = serverStudents;
                console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:', allStudents.length, '—É—á–µ–Ω–∏–∫–æ–≤');
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                allStudents = [
                    {
                        firstName: '–ò–≤–∞–Ω',
                        lastName: '–ò–≤–∞–Ω–æ–≤',
                        grade: '8',
                        classLetter: 'A',
                        subgroup: '1',
                        lastLogin: new Date().toISOString(),
                        currentPart: 1,
                        currentLevel: 5,
                        experience: 1250
                    }
                ];
            }

            filteredStudents = [...allStudents];
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const tbody = document.getElementById('studentsTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const totalCount = document.getElementById('totalCount');
            const totalStudents = document.getElementById('totalStudents');
            const avgLevel = document.getElementById('avgLevel');
            const avgExperience = document.getElementById('avgExperience');
            const activeToday = document.getElementById('activeToday');
        
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.style.display = 'block';
                totalCount.textContent = '–í—Å–µ–≥–æ: 0 —É—á–µ–Ω–∏–∫–æ–≤';
                totalStudents.textContent = '0';
                avgLevel.textContent = '0';
                avgExperience.textContent = '0';
                activeToday.textContent = '0';
                return;
            }
        
            noDataMessage.style.display = 'none';
            totalCount.textContent = `–í—Å–µ–≥–æ: ${filteredStudents.length} —É—á–µ–Ω–∏–∫–æ–≤`;
            totalStudents.textContent = filteredStudents.length;
        
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const totalLevel = filteredStudents.reduce((sum, student) => sum + (student.currentLevel || 0), 0);
            const totalExp = filteredStudents.reduce((sum, student) => sum + (student.experience || 0), 0);
            const today = new Date().toDateString();
            const todayActive = filteredStudents.filter(student => {
                if (!student.lastLogin) return false;
                const loginDate = new Date(student.lastLogin).toDateString();
                return loginDate === today;
            }).length;
        
            avgLevel.textContent = filteredStudents.length > 0 ? (totalLevel / filteredStudents.length).toFixed(1) : '0';
            avgExperience.textContent = filteredStudents.length > 0 ? Math.round(totalExp / filteredStudents.length) : '0';
            activeToday.textContent = todayActive;
        
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort) {
                    th.classList.add(sortAscending ? 'sort-asc' : 'sort-desc');
                }
            });
        
            let html = '';
            filteredStudents.forEach(student => {
                let formattedDate = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                let isToday = false;
        
                if (student.lastLogin) {
                    const loginDate = new Date(student.lastLogin);
                    formattedDate = loginDate.toLocaleDateString('ru-RU') + ' ' +
                                   loginDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                    isToday = new Date().toDateString() === loginDate.toDateString();
                }
        
                // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∏ —É—Ä–æ–∫–∞
                const levelDisplay = (student.currentLevel || 0) + 1;
                let lessonDisplay = '';
                
                // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç currentPart
                if (typeof student.currentPart === 'string' && student.currentPart.includes('.')) {
                    // –§–æ—Ä–º–∞—Ç –∏–∑ game1.js: "1.1", "1.2", "1.3"
                    lessonDisplay = `–£—Ä–æ–∫ ${student.currentPart}`;
                } else if (typeof student.currentPart === 'number') {
                    // –§–æ—Ä–º–∞—Ç –∏–∑ game2.js: 2, 3 –∏ —Ç.–¥.
                    lessonDisplay = `–£—Ä–æ–∫ ${student.currentPart}`;
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    lessonDisplay = `–£—Ä–æ–∫ ${student.currentPart || 1}`;
                }
        
                // üîß –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞ —É—Ä–æ–∫–∞
                let lessonClass = 1;
                if (typeof student.currentPart === 'string' && student.currentPart.includes('.')) {
                    lessonClass = parseInt(student.currentPart.split('.')[0]);
                } else if (typeof student.currentPart === 'number') {
                    lessonClass = student.currentPart;
                } else {
                    lessonClass = student.currentPart || 1;
                }
        
                html += `
                    <tr>
                        <td>${student.lastName || ''}</td>
                        <td>${student.firstName || ''}</td>
                        <td class="class-cell">${student.grade || ''}</td>
                        <td class="class-cell">${student.classLetter || '–ê'}</td>
                        <td>${student.subgroup || '1'}</td>
                        <td>${formattedDate} ${isToday ? '(—Å–µ–≥–æ–¥–Ω—è)' : ''}</td>
                        <td><span class="level-cell level-${lessonClass}">${lessonDisplay}</span></td>
                        <td><span class="level-cell level-${student.currentLevel || 1}">${levelDisplay}</span></td>
                        <td class="experience-cell">${student.experience || 0}</td>
                    </tr>
                `;
            });
        
            tbody.innerHTML = html;
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const classLetterFilter = document.getElementById('classLetterFilter').value;
            const subgroupFilter = document.getElementById('subgroupFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = allStudents.filter(student => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∞—Å—Å—É (–ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
                if (gradeFilter && String(student.grade) !== gradeFilter) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ –±—É–∫–≤–µ –∫–ª–∞—Å—Å–∞
                if (classLetterFilter && student.classLetter !== classLetterFilter) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–¥–≥—Ä—É–ø–ø–µ (–ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
                if (subgroupFilter && String(student.subgroup) !== subgroupFilter) return false;

                // –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∞–º–∏–ª–∏–∏
                if (searchFilter && !student.lastName.toLowerCase().includes(searchFilter)) return false;

                return true;
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            sortStudents(currentSort, sortAscending);
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        function sortStudents(sortBy, ascending = true) {
            currentSort = sortBy;
            sortAscending = ascending;

            filteredStudents.sort((a, b) => {
                let valueA, valueB;

                if (sortBy === 'lastName') {
                    valueA = (a.lastName || '').toLowerCase();
                    valueB = (b.lastName || '').toLowerCase();
                } else if (sortBy === 'firstName') {
                    valueA = (a.firstName || '').toLowerCase();
                    valueB = (b.firstName || '').toLowerCase();
                } else if (sortBy === 'grade') {
                    valueA = parseInt(a.grade) || 0;
                    valueB = parseInt(b.grade) || 0;
                } else if (sortBy === 'classLetter') {
                    valueA = a.classLetter || '–ê';
                    valueB = b.classLetter || '–ê';
                } else if (sortBy === 'subgroup') {
                    valueA = a.subgroup || '';
                    valueB = b.subgroup || '';
                } else if (sortBy === 'lastLogin') {
                    valueA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                    valueB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                } else if (sortBy === 'currentPart') {
                    valueA = a.currentPart || 1;
                    valueB = b.currentPart || 1;
                } else if (sortBy === 'currentLevel') {
                    valueA = a.currentLevel || 1;
                    valueB = b.currentLevel || 1;
                } else if (sortBy === 'experience') {
                    valueA = a.experience || 0;
                    valueB = b.experience || 0;
                }

                if (valueA < valueB) return ascending ? -1 : 1;
                if (valueA > valueB) return ascending ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            document.getElementById('gradeFilter').value = '';
            document.getElementById('classLetterFilter').value = '';
            document.getElementById('subgroupFilter').value = '';
            document.getElementById('searchFilter').value = '';

            filteredStudents = [...allStudents];
            sortStudents('lastName', true);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            sessionStorage.removeItem('teacherLoggedIn');
            window.location.href = 'index.html';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            checkTeacherAuth();
            await initData();
            sortStudents('lastName', true);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);

            document.getElementById('sortByName').addEventListener('click', function() {
                sortStudents('lastName', true);
            });

            document.getElementById('sortByExperience').addEventListener('click', function() {
                sortStudents('experience', false);
            });

            document.getElementById('sortByClass').addEventListener('click', function() {
                sortStudents('grade', true);
            });

            document.getElementById('sortByLevel').addEventListener('click', function() {
                sortStudents('currentLevel', false);
            });

            document.getElementById('logoutBtn').addEventListener('click', logout);

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const sortBy = this.dataset.sort;
                    if (currentSort === sortBy) {
                        sortStudents(sortBy, !sortAscending);
                    } else {
                        sortStudents(sortBy, true);
                    }
                });
            });

            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchFilter').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
            document.getElementById('gradeFilter').addEventListener('change', applyFilters);
            document.getElementById('classLetterFilter').addEventListener('change', applyFilters);
            document.getElementById('subgroupFilter').addEventListener('change', applyFilters);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(async () => {
                const freshStudents = await loadStudentsFromServer();
                if (freshStudents.length > 0) {
                    allStudents = freshStudents;
                    applyFilters();
                }
            }, 30000);
        });
    </script>
</body>
</html>
